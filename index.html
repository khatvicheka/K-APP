<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Korean Learning App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- Inter font from Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- jQuery CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* Light gray background */
      }
      .container {
        max-width: 1200px;
      }
      .section-content {
        display: none; /* Hidden by default */
      }
      .section-content.active {
        display: block; /* Shown when active */
      }
      /* Custom scrollbar for data lists */
      .overflow-y-auto::-webkit-scrollbar {
        width: 8px;
      }
      .overflow-y-auto::-webkit-scrollbar-track {
        background: #e0e0e0;
        border-radius: 10px;
      }
      .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #9ca3af;
        border-radius: 10px;
      }
      .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      /* Basic styling for modals */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem; /* rounded-lg */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        width: 90%;
        max-width: 600px;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
      }
      .quiz-option-button {
        transition: background-color 0.2s ease, transform 0.1s ease;
      }
      .quiz-option-button:hover {
        transform: translateY(-2px);
      }
      .quiz-option-button.correct {
        background-color: #34d399; /* green-400 */
        color: white;
      }
      .quiz-option-button.incorrect {
        background-color: #ef4444; /* red-500 */
        color: white;
      }
      .quiz-option-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      /* Status chip styling */
      .status-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.65rem;
        border-radius: 9999px; /* full rounded */
        font-size: 0.75rem; /* text-xs */
        font-weight: 500; /* font-medium */
        line-height: 1;
      }
      .status-new {
        background-color: #bfdbfe; /* blue-200 */
        color: #1e40af; /* blue-800 */
      }
      .status-learning {
        background-color: #fefcbf; /* yellow-200 */
        color: #b45309; /* yellow-800 */
      }
      .status-review {
        background-color: #e9d5ff; /* purple-200 */
        color: #6b21a8; /* purple-800 */
      }
      .status-mastered {
        background-color: #d1fae5; /* green-200 */
        color: #065f46; /* green-800 */
      }
      .status-default {
        /* Fallback for unrecognized status */
        background-color: #e5e7eb; /* gray-200 */
        color: #4b5563; /* gray-700 */
      }
      /* Resource tag styling - Updated to match status chip border-radius */
      .resource-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.2rem 0.5rem;
        margin: 0.15rem;
        border-radius: 9999px; /* Changed to full rounded */
        font-size: 0.7rem; /* text-xs slightly smaller */
        background-color: #e0f2fe; /* blue-50 */
        color: #2563eb; /* blue-600 */
        border: 1px solid #93c5fd; /* blue-300 */
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        white-space: nowrap; /* Prevent breaking into multiple lines */
        overflow: hidden; /* Hide overflow content */
        text-overflow: ellipsis; /* Show ellipsis for truncated text */
        max-width: 90px; /* Make the overall tag shorter */
      }
      .resource-tag:hover {
        background-color: #dbeafe; /* blue-100 */
        border-color: #60a5fa; /* blue-400 */
      }
      .resource-tag-url {
        background-color: #eef2ff; /* indigo-50 */
        color: #4f46e5; /* indigo-600 */
        border: 1px solid #a5b4fc; /* indigo-300 */
      }
      .resource-tag-url:hover {
        background-color: #e0e7ff; /* indigo-100 */
        border-color: #818cf8; /* indigo-400 */
      }
      .resource-tag span {
        /* Span inside the tag for text truncation */
        max-width: 80px; /* Max width for the text within the tag */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block; /* Essential for truncation on inline-flex parent */
        vertical-align: middle; /* Align with icon */
      }
      /* Ensure the column content div has enough space but is constrained */
      .resource-cell-content {
        display: flex;
        flex-wrap: wrap;
        gap: 0.15rem; /* Tighter gap for chips */
        max-width: 180px; /* Max width for the entire cell content */
        overflow-x: hidden; /* Hide if content still overflows */
      }

      /* Floating action button for Guide */
      #guideFab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #4f46e5; /* indigo-600 */
        color: white;
        border-radius: 9999px; /* full rounded */
        width: 56px;
        height: 56px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: background-color 0.3s ease, transform 0.2s ease;
        cursor: pointer;
        z-index: 999;
      }
      #guideFab:hover {
        background-color: #4338ca; /* indigo-700 */
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Header Navigation -->
    <header
      class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg p-4"
    >
      <div
        class="container mx-auto flex flex-col sm:flex-row justify-between items-center"
      >
        <h1 class="text-3xl font-bold mb-4 sm:mb-0">K-APP</h1>
        <nav>
          <ul class="flex space-x-4">
            <li>
              <a
                href="#"
                class="nav-link text-lg hover:text-blue-200 transition duration-300 ease-in-out active:text-blue-100"
                data-section="vocabulary"
                >Vocabulary</a
              >
            </li>
            <li>
              <a
                href="#"
                class="nav-link text-lg hover:text-blue-200 transition duration-300 ease-in-out active:text-blue-100"
                data-section="grammar"
                >Grammar</a
              >
            </li>
            <li>
              <a
                href="#"
                class="nav-link text-lg hover:text-blue-200 transition duration-300 ease-in-out active:text-blue-100"
                data-section="review-quiz"
                >Review & Quiz</a
              >
            </li>
            <li>
              <a
                href="#"
                class="nav-link text-lg hover:text-blue-200 transition duration-300 ease-in-out active:text-blue-100"
                data-section="settings"
                >Settings</a
              >
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-6 md:p-8">
      <!-- Vocabulary Section -->
      <section
        id="vocabulary"
        class="section-content active bg-white p-6 rounded-xl shadow-lg"
      >
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3">
          Vocabulary <i class="fas fa-book text-blue-500 ml-2"></i>
        </h2>
        <div class="flex flex-wrap items-center gap-4 mb-6">
          <input
            type="text"
            id="vocabSearch"
            placeholder="Search vocabulary..."
            class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
          />
          <select
            id="vocabCategoryFilter"
            class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
          >
            <option value="">All Categories</option>
          </select>
          <select
            id="vocabStatusFilter"
            class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
          >
            <option value="">All Statuses</option>
          </select>
          <button
            id="addVocabBtn"
            class="bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out flex items-center shadow-md"
          >
            <i class="fas fa-plus mr-2"></i> Add New
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-sm">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg"
                >
                  Korean
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                >
                  English
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                >
                  Category
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                  style="width: 180px"
                >
                  Resource(s)
                </th>
                <th
                  class="py-3 px-4 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="vocabList" class="divide-y divide-gray-100">
              <!-- Vocabulary items will be rendered here by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="flex justify-between items-center mt-6">
          <button
            id="vocabPrevPage"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Previous
          </button>
          <span id="vocabPageInfo" class="text-gray-600">Page 1 of 1</span>
          <button
            id="vocabNextPage"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </section>

      <!-- Grammar Section -->
      <section
        id="grammar"
        class="section-content bg-white p-6 rounded-xl shadow-lg"
      >
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3">
          Grammar <i class="fas fa-pencil-alt text-blue-500 ml-2"></i>
        </h2>
        <div class="flex flex-wrap items-center gap-4 mb-6">
          <input
            type="text"
            id="grammarSearch"
            placeholder="Search grammar..."
            class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
          />
          <select
            id="grammarCategoryFilter"
            class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
          >
            <option value="">All Categories</option>
          </select>
          <select
            id="grammarStatusFilter"
            class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
          >
            <option value="">All Statuses</option>
          </select>
          <button
            id="addGrammarBtn"
            class="bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out flex items-center shadow-md"
          >
            <i class="fas fa-plus mr-2"></i> Add New
          </button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-sm">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg"
                >
                  Korean
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                >
                  English
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                >
                  Category
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider"
                  style="width: 180px"
                >
                  Resource(s)
                </th>
                <th
                  class="py-3 px-4 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="grammarList" class="divide-y divide-gray-100">
              <!-- Grammar items will be rendered here by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="flex justify-between items-center mt-6">
          <button
            id="grammarPrevPage"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Previous
          </button>
          <span id="grammarPageInfo" class="text-gray-600">Page 1 of 1</span>
          <button
            id="grammarNextPage"
            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Next
          </button>
        </div>
      </section>

      <!-- Review & Quiz Section -->
      <section
        id="review-quiz"
        class="section-content bg-white p-6 rounded-xl shadow-lg"
      >
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3">
          Review & Quiz <i class="fas fa-graduation-cap text-blue-500 ml-2"></i>
        </h2>
        <div class="flex flex-col md:flex-row gap-6 mb-6">
          <button
            id="startFlashcardsBtn"
            class="bg-purple-600 text-white px-5 py-3 rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out flex items-center justify-center shadow-md flex-grow"
          >
            <i class="fas fa-clone mr-2"></i> Start Flashcards
          </button>
          <button
            id="startQuizBtn"
            class="bg-teal-600 text-white px-5 py-3 rounded-lg hover:bg-teal-700 transition duration-300 ease-in-out flex items-center justify-center shadow-md flex-grow"
          >
            <i class="fas fa-question-circle mr-2"></i> Start Quiz
          </button>
        </div>

        <!-- Flashcard UI -->
        <div
          id="flashcardContainer"
          class="hidden flex flex-col items-center justify-center bg-gray-100 p-8 rounded-xl shadow-inner min-h-[300px]"
        >
          <h3 class="text-2xl font-semibold mb-4 text-gray-700">
            Flashcard Mode
          </h3>
          <div
            id="flashcard"
            class="relative bg-white w-full max-w-md h-48 md:h-64 flex items-center justify-center text-3xl font-bold text-gray-800 border-2 border-blue-400 rounded-lg shadow-md cursor-pointer transition-transform duration-300 transform-gpu hover:scale-105"
          >
            <span id="flashcardContent">Click to reveal!</span>
            <span
              id="flashcardSide"
              class="absolute bottom-2 right-3 text-sm text-gray-500 italic"
              >Korean</span
            >
          </div>
          <div class="flex space-x-4 mt-6">
            <button
              id="nextFlashcardBtn"
              class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-300 ease-in-out shadow-md"
            >
              Next Card <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>

        <!-- Quiz UI -->
        <div
          id="quizContainer"
          class="hidden flex flex-col items-center justify-center bg-gray-100 p-8 rounded-xl shadow-inner min-h-[400px]"
        >
          <h3 class="text-2xl font-semibold mb-4 text-gray-700">Quiz Mode</h3>
          <p
            id="quizQuestion"
            class="text-xl font-medium text-gray-800 text-center mb-6 max-w-lg"
          ></p>
          <div
            id="quizOptions"
            class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-lg mb-6"
          >
            <!-- Quiz options will be rendered here -->
          </div>
          <div class="flex items-center space-x-4 mb-4">
            <p class="text-lg font-semibold text-gray-700">
              Score: <span id="quizScore" class="text-blue-600">0</span>
            </p>
            <p class="text-lg font-semibold text-gray-700">
              Question:
              <span id="quizCurrentQuestion" class="text-blue-600">0</span> /
              <span id="quizTotalQuestions" class="text-blue-600">0</span>
            </p>
          </div>
          <button
            id="nextQuizQuestionBtn"
            class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-300 ease-in-out shadow-md hidden"
          >
            Next Question <i class="fas fa-arrow-right ml-2"></i>
          </button>
          <button
            id="restartQuizBtn"
            class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-300 ease-in-out shadow-md hidden mt-4"
          >
            Restart Quiz <i class="fas fa-sync-alt ml-2"></i>
          </button>
        </div>
      </section>

      <!-- Settings Section -->
      <section
        id="settings"
        class="section-content bg-white p-6 rounded-xl shadow-lg"
      >
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-3">
          Settings <i class="fas fa-cog text-blue-500 ml-2"></i>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-10">
          <!-- Manage Categories Section -->
          <div
            class="md:col-span-2 bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200"
          >
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">
              Manage Categories <i class="fas fa-tags text-gray-500 ml-2"></i>
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Vocabulary Categories -->
              <div
                class="bg-white p-4 rounded-lg shadow-inner border border-gray-200"
              >
                <h4 class="text-xl font-medium text-gray-800 mb-3">
                  Vocabulary Categories
                </h4>
                <div class="flex mb-3">
                  <input
                    type="text"
                    id="newVocabCategoryInput"
                    placeholder="New category name"
                    class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500"
                  />
                  <button
                    id="addVocabCategoryBtn"
                    class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600 transition duration-300"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <ul
                  id="vocabCategoryList"
                  class="list-disc pl-5 max-h-40 overflow-y-auto"
                >
                  <!-- Vocab categories will be listed here -->
                </ul>
                <div class="flex justify-between items-center mt-3">
                  <button
                    id="vocabCategoryPrevPage"
                    class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                  >
                    Previous
                  </button>
                  <span id="vocabCategoryPageInfo" class="text-gray-600 text-sm"
                    >Page 1 of 1</span
                  >
                  <button
                    id="vocabCategoryNextPage"
                    class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                  >
                    Next
                  </button>
                </div>
              </div>
              <!-- Grammar Categories -->
              <div
                class="bg-white p-4 rounded-lg shadow-inner border border-gray-200"
              >
                <h4 class="text-xl font-medium text-gray-800 mb-3">
                  Grammar Categories
                </h4>
                <div class="flex mb-3">
                  <input
                    type="text"
                    id="newGrammarCategoryInput"
                    placeholder="New category name"
                    class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500"
                  />
                  <button
                    id="addGrammarCategoryBtn"
                    class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600 transition duration-300"
                  >
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <ul
                  id="grammarCategoryList"
                  class="list-disc pl-5 max-h-40 overflow-y-auto"
                >
                  <!-- Grammar categories will be listed here -->
                </ul>
                <div class="flex justify-between items-center mt-3">
                  <button
                    id="grammarCategoryPrevPage"
                    class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                  >
                    Previous
                  </button>
                  <span
                    id="grammarCategoryPageInfo"
                    class="text-gray-600 text-sm"
                    >Page 1 of 1</span
                  >
                  <button
                    id="grammarCategoryNextPage"
                    class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Learning Statuses Section -->
          <div
            class="bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200"
          >
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">
              Manage Learning Statuses
              <i class="fas fa-chart-line text-gray-500 ml-2"></i>
            </h3>
            <div class="flex mb-3">
              <input
                type="text"
                id="newStatusInput"
                placeholder="New status name"
                class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500"
              />
              <button
                id="addStatusBtn"
                class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600 transition duration-300"
              >
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <ul id="statusList" class="list-disc pl-5 max-h-40 overflow-y-auto">
              <!-- Statuses will be listed here -->
            </ul>
            <div class="flex justify-between items-center mt-3">
              <button
                id="statusPrevPage"
                class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
              >
                Previous
              </button>
              <span id="statusPageInfo" class="text-gray-600 text-sm"
                >Page 1 of 1</span
              >
              <button
                id="statusNextPage"
                class="bg-gray-300 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
              >
                Next
              </button>
            </div>
          </div>

          <!-- Spacer div to push the data management section to a new row if needed -->
          <div class="hidden md:block"></div>

          <!-- Data Management Section -->
          <div
            class="md:col-span-2 bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200"
          >
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">
              Data Management <i class="fas fa-database text-gray-500 ml-2"></i>
            </h3>
            <div class="flex flex-wrap gap-4">
              <button
                id="exportDataBtn"
                class="bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition duration-300 flex items-center shadow-md"
              >
                <i class="fas fa-download mr-2"></i> Export Data
              </button>
              <button
                id="downloadSampleDataBtn"
                class="bg-blue-500 text-white px-5 py-3 rounded-lg hover:bg-blue-600 transition duration-300 flex items-center shadow-md"
              >
                <i class="fas fa-file-download mr-2"></i> Download Sample
              </button>
              <label
                for="importFileInput"
                class="bg-orange-600 text-white px-5 py-3 rounded-lg hover:bg-orange-700 transition duration-300 cursor-pointer flex items-center shadow-md"
              >
                <i class="fas fa-upload mr-2"></i> Import Data
              </label>
              <input
                type="file"
                id="importFileInput"
                class="hidden"
                accept=".json"
              />
              <button
                id="clearDataBtn"
                class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700 transition duration-300 flex items-center shadow-md"
              >
                <i class="fas fa-trash-alt mr-2"></i> Clear All Data
              </button>
            </div>
          </div>

          <!-- Gemini API Key Section -->
          <div
            class="md:col-span-2 bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200"
          >
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">
              Gemini API Key <i class="fas fa-key text-gray-500 ml-2"></i>
            </h3>
            <div class="flex flex-col sm:flex-row gap-4">
              <input
                type="password"
                id="geminiApiKeyInput"
                placeholder="Enter your Gemini API Key"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
              />
              <button
                id="saveApiKeyBtn"
                class="bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md"
              >
                <i class="fas fa-save mr-2"></i> Save Key
              </button>
              <button
                id="testApiKeyBtn"
                class="bg-gray-600 text-white px-5 py-3 rounded-lg hover:bg-gray-700 transition duration-300 shadow-md"
              >
                <i class="fas fa-vial mr-2"></i> Test Key
              </button>
            </div>
            <p id="apiKeyStatus" class="mt-2 text-sm text-gray-600"></p>
          </div>
        </div>
      </section>
    </main>

    <!-- Vocabulary/Grammar Add/Edit Modal -->
    <div id="dataModal" class="modal-overlay">
      <div class="modal-content">
        <h3
          id="dataModalTitle"
          class="text-2xl font-bold mb-4 text-gray-800"
        ></h3>
        <form id="dataForm" class="space-y-4">
          <div>
            <label
              for="koreanInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Korean:</label
            >
            <input
              type="text"
              id="koreanInput"
              class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              required
            />
          </div>
          <div>
            <label
              for="englishInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >English:</label
            >
            <input
              type="text"
              id="englishInput"
              class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              required
            />
          </div>
          <div>
            <label
              for="categorySelect"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Category:</label
            >
            <select
              id="categorySelect"
              class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            ></select>
          </div>
          <div>
            <label
              for="statusSelect"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Status:</label
            >
            <select
              id="statusSelect"
              class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            ></select>
          </div>
          <div>
            <label
              for="resourceInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Resource(s):</label
            >
            <input
              type="text"
              id="resourceInput"
              class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="e.g., https://example.com/info, My notes"
            />
            <p class="text-xs text-gray-500 mt-1">
              Enter multiple resources separated by commas (URLs or plain text).
            </p>
            <p class="text-xs text-gray-500 mt-1">
              For adding multiple items efficiently, use "Download Sample" and
              "Import Data (Append)" in Settings.
            </p>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              id="cancelDataModalBtn"
              class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-400 transition duration-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300"
            >
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- AI Explanation Modal -->
    <div id="aiModal" class="modal-overlay">
      <div class="modal-content">
        <h3 class="text-2xl font-bold mb-4 text-gray-800">
          AI Explanation <i class="fas fa-robot text-blue-500 ml-2"></i>
        </h3>
        <div
          id="aiModalContent"
          class="bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto text-gray-700 mb-4"
        >
          <p>Loading explanation...</p>
        </div>
        <div class="flex justify-end">
          <button
            type="button"
            id="closeAiModalBtn"
            class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-400 transition duration-300"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Confirmation/Message Modal (reused for general messages, and import choices) -->
    <div id="messageModal" class="modal-overlay">
      <div class="modal-content">
        <h3
          id="messageModalTitle"
          class="text-xl font-bold mb-4 text-gray-800"
        ></h3>
        <p id="messageModalText" class="text-gray-700 mb-6"></p>
        <div id="messageModalActions" class="flex justify-end space-x-3">
          <!-- Buttons will be dynamically added/hidden based on context -->
          <button
            type="button"
            id="confirmMessageModalBtn"
            class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition duration-300 hidden"
          >
            Confirm
          </button>
          <button
            type="button"
            id="cancelMessageModalBtn"
            class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-400 transition duration-300 hidden"
          >
            Cancel
          </button>
          <button
            type="button"
            id="closeMessageModalBtn"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 hidden"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Quick Practice Modal -->
    <div id="practiceModal" class="modal-overlay">
      <div class="modal-content">
        <h3 class="text-2xl font-bold mb-4 text-gray-800">
          Quick Practice <i class="fas fa-keyboard text-blue-500 ml-2"></i>
        </h3>
        <p
          id="practiceKorean"
          class="text-3xl font-bold text-center text-blue-700 mb-6"
        ></p>
        <div class="space-y-4">
          <div>
            <label
              for="practiceAnswerInput"
              class="block text-gray-700 text-sm font-bold mb-2"
              >Your English Answer:</label
            >
            <input
              type="text"
              id="practiceAnswerInput"
              class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Type your answer here"
            />
          </div>
          <p
            id="practiceFeedback"
            class="text-center text-lg font-semibold min-h-[1.5em]"
          ></p>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button
            type="button"
            id="checkPracticeAnswerBtn"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300"
          >
            Check Answer
          </button>
          <button
            type="button"
            id="closePracticeModalBtn"
            class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-400 transition duration-300"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Guide/About Modal -->
    <div id="guideModal" class="modal-overlay">
      <div class="modal-content max-w-2xl">
        <h3 class="text-2xl font-bold mb-4 text-gray-800">
          App Guide <i class="fas fa-info-circle text-blue-500 ml-2"></i>
        </h3>
        <div class="tabs mb-4 border-b border-gray-200">
          <button
            class="tab-button py-2 px-4 text-gray-600 hover:text-blue-600 hover:border-blue-600 border-b-2 border-transparent active-tab-button"
            data-tab="about"
          >
            About
          </button>
          <button
            class="tab-button py-2 px-4 text-gray-600 hover:text-blue-600 hover:border-blue-600 border-b-2 border-transparent"
            data-tab="how-to-use"
          >
            How to Use
          </button>
        </div>

        <div
          id="aboutTab"
          class="tab-content active-tab-content bg-gray-50 p-4 rounded-lg text-gray-700 prose max-w-none"
        >
          <h4 class="text-xl font-semibold mb-2">About This App</h4>
          <p>
            This is a Smart Korean Learning App designed to help you organize
            and practice your Korean vocabulary and grammar efficiently. It uses
            local storage to save your data directly in your browser, ensuring
            your information is private and always available without an internet
            connection (once loaded).
          </p>
          <p>
            Key features include managing vocabulary and grammar entries,
            categorizing them, tracking learning progress, reviewing with
            flashcards, testing knowledge with quizzes, and integrating with AI
            for explanations (requires a Gemini API key).
          </p>
          <p>
            This application operates entirely offline once loaded in your
            browser, and all your data is stored locally. This means your
            learning progress is private and secure on your device.
          </p>
        </div>

        <div
          id="howToUseTab"
          class="tab-content hidden bg-gray-50 p-4 rounded-lg text-gray-700 prose max-w-none"
        >
          <h4 class="text-xl font-semibold mb-2">How to Use</h4>
          <p>
            Below is a guide to help you get the most out of this Korean
            Learning App:
          </p>
          <h5 class="text-lg font-semibold mt-4 mb-2">1. Navigation</h5>
          <ul>
            <li>
              Use the navigation links in the header (Vocabulary, Grammar,
              Review & Quiz, Settings) to switch between different sections of
              the app.
            </li>
          </ul>
          <h5 class="text-lg font-semibold mt-4 mb-2">
            2. Vocabulary & Grammar Sections
          </h5>
          <ul>
            <li>
              <strong>Search Bar:</strong> Type in the search bar to quickly
              find specific vocabulary words or grammar patterns.
            </li>
            <li>
              <strong>Category Filter:</strong> Use the dropdown to filter items
              by their assigned categories.
            </li>
            <li>
              <strong>Status Filter:</strong> Use the dropdown to filter items
              by their learning status.
            </li>
            <li>
              <strong>Add New Button:</strong> Click this button to add a new
              vocabulary word or grammar pattern.
            </li>
            <li>
              <strong>Table Actions:</strong> Each row in the table provides
              action buttons:
              <ul>
                <li>
                  <i class="fas fa-robot text-blue-500"></i> (Ask AI): Get an
                  explanation for the item using the Gemini AI (requires API
                  Key).
                </li>
                <li>
                  <i class="fas fa-keyboard text-green-500"></i> (Practice):
                  Start a quick typing practice session for that specific item.
                </li>
                <li>
                  <i class="fas fa-edit text-yellow-500"></i> (Edit): Modify the
                  details of an existing item.
                </li>
                <li>
                  <i class="fas fa-trash text-red-500"></i> (Delete): Remove an
                  item from your list.
                </li>
              </ul>
            </li>
            <li>
              <strong>Pagination:</strong> Use the "Previous" and "Next" buttons
              at the bottom of the table to navigate through pages if you have
              many entries.
            </li>
            <li>
              <strong>Resource Field:</strong> When adding or editing an item,
              you can enter multiple resources (URLs or plain text) separated by
              commas in the "Resource(s)" field. For adding multiple items
              efficiently (e.g., from a spreadsheet), consider using the
              "Download Sample" and "Import Data (Append)" features in the
              Settings section.
            </li>
          </ul>
          <h5 class="text-lg font-semibold mt-4 mb-2">
            3. Review & Quiz Section
          </h5>
          <ul>
            <li>
              <strong>Start Flashcards:</strong> Begin a flashcard session with
              all your vocabulary and grammar items. Click on the card to flip
              between Korean and English. Use "Next Card" to proceed.
            </li>
            <li>
              <strong>Start Quiz:</strong> Take a multiple-choice quiz based on
              your entries to test your understanding. Your score will be
              tracked.
            </li>
          </ul>
          <h5 class="text-lg font-semibold mt-4 mb-2">4. Settings Section</h5>
          <ul>
            <li>
              <strong>Manage Categories:</strong>
              <ul>
                <li>
                  Add new custom categories for both vocabulary and grammar.
                </li>
                <li>
                  Delete existing categories. Items associated with a deleted
                  category will be set to 'Uncategorized'.
                </li>
                <li>
                  Use "Previous" and "Next" buttons to paginate through your
                  categories if you have many.
                </li>
              </ul>
            </li>
            <li>
              <strong>Manage Learning Statuses:</strong>
              <ul>
                <li>
                  Add new custom learning statuses (e.g., "Fluent", "Needs
                  Work").
                </li>
                <li>
                  Delete existing statuses. Items with a deleted status will be
                  reset to 'New' or the first available status.
                </li>
                <li>
                  Use "Previous" and "Next" buttons to paginate through your
                  statuses.
                </li>
              </ul>
            </li>
            <li>
              <strong>Data Management:</strong>
              <ul>
                <li>
                  <strong>Export Data:</strong> Download your entire app data as
                  a JSON file to your computer. This is great for backups!
                </li>
                <li>
                  <strong>Download Sample:</strong> Download a sample JSON file
                  to see the data structure or to get started with some example
                  entries.
                </li>
                <li>
                  <strong>Import Data:</strong> Upload a JSON file. You will be
                  prompted to choose whether to
                  <strong>Append Data</strong> (add to your existing data,
                  updating items if IDs match) or
                  <strong>Replace All Data</strong> (overwrite everything with
                  the imported file).
                </li>
                <li>
                  <strong>Clear All Data:</strong> Permanently delete all your
                  vocabulary, grammar, categories, and statuses from the app.
                  Use with extreme caution!
                </li>
              </ul>
            </li>
            <li>
              <strong>Gemini API Key:</strong>
              <ul>
                <li>
                  Enter your personal Gemini API Key here to enable AI-powered
                  explanations.
                </li>
                <li>
                  Click "Save Key" to store it securely in your browser's local
                  storage.
                </li>
                <li>
                  Click "Test Key" to verify if your API key is working
                  correctly.
                </li>
              </ul>
            </li>
          </ul>
          <p class="text-sm italic mt-4">
            Your data is saved automatically in your browser's local storage.
            There is no server-side storage, keeping your data private to your
            device.
          </p>
        </div>

        <div class="flex justify-end mt-6">
          <button
            type="button"
            id="closeGuideModalBtn"
            class="bg-gray-300 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-400 transition duration-300"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Floating Action Button for Guide -->
    <button id="guideFab" title="App Guide">
      <i class="fas fa-question"></i>
    </button>

    <script>
      const app = {
        data: {
          vocabularies: [],
          grammars: [],
          vocabCategories: ["Basic Greetings", "Food", "Places", "Actions"],
          grammarCategories: [
            "Basic Endings",
            "Conjunctions",
            "Honorifics",
            "Tenses",
          ],
          learningStatuses: ["New", "Learning", "Review", "Mastered"],
          geminiApiKey: "",
        },
        currentSection: "vocabulary",
        itemsPerPage: 10, // For main tables
        settingsItemsPerPage: 5, // For settings lists

        // Pagination state for main tables
        vocabCurrentPage: 1,
        grammarCurrentPage: 1,

        // Pagination state for settings lists
        vocabCategoryCurrentPage: 1,
        grammarCategoryCurrentPage: 1,
        statusCurrentPage: 1,

        quiz: {
          currentQuestionIndex: 0,
          score: 0,
          questions: [],
          allWords: [],
        },

        // --- Core Data Management ---
        loadData() {
          try {
            const savedData = localStorage.getItem("koreanLearningApp");
            if (savedData) {
              const parsedData = JSON.parse(savedData);
              // Merge with default data to ensure all keys exist and new properties are not lost on load
              this.data = { ...this.data, ...parsedData };
              // Ensure newly added default statuses are present if not in loaded data
              if (
                !parsedData.learningStatuses ||
                parsedData.learningStatuses.length === 0
              ) {
                this.data.learningStatuses = [
                  "New",
                  "Learning",
                  "Review",
                  "Mastered",
                ];
              }
              // Ensure 'resource' property in vocabularies and grammars is always an array
              this.data.vocabularies.forEach((item) => {
                if (typeof item.resource === "string") {
                  item.resource = item.resource
                    .split(",")
                    .map((s) => s.trim())
                    .filter((s) => s);
                } else if (!Array.isArray(item.resource)) {
                  item.resource = [];
                }
              });
              this.data.grammars.forEach((item) => {
                if (typeof item.resource === "string") {
                  item.resource = item.resource
                    .split(",")
                    .map((s) => s.trim())
                    .filter((s) => s);
                } else if (!Array.isArray(item.resource)) {
                  item.resource = [];
                }
              });
            }
          } catch (e) {
            console.error("Error loading data from localStorage:", e);
            this.showMessage(
              "Error",
              "Failed to load data from local storage. Your data might be corrupted.",
              false
            );
          }
          this.updateCategoryFilters();
          this.updateStatusFilters(); // Call to update status filters
        },

        saveData() {
          try {
            localStorage.setItem(
              "koreanLearningApp",
              JSON.stringify(this.data)
            );
          } catch (e) {
            console.error("Error saving data to localStorage:", e);
            this.showMessage(
              "Error",
              "Failed to save data to local storage. Please check your browser's storage settings.",
              false
            );
          }
        },

        // --- UI Modals ---
        showModal(
          modalId,
          title = "",
          message = "",
          isConfirm = false,
          onConfirm = null
        ) {
          const $modal = $(`#${modalId}`);
          const $title = $modal.find(`#${modalId}Title`);
          const $text = $modal.find(`#${modalId}Text`);
          const $confirmBtn = $modal.find(`#confirmMessageModalBtn`);
          const $cancelBtn = $modal.find(`#cancelMessageModalBtn`); // Added for explicit cancel
          const $closeBtn = $modal.find(`#closeMessageModalBtn`);

          // Reset visibility for all buttons
          $confirmBtn.addClass("hidden").off("click");
          $cancelBtn.addClass("hidden").off("click");
          $closeBtn.addClass("hidden").off("click");

          if (modalId === "messageModal") {
            $title.text(title);
            $text.text(message);
            if (isConfirm) {
              $confirmBtn.removeClass("hidden");
              $cancelBtn.removeClass("hidden");
              $confirmBtn.on("click", () => {
                $modal.removeClass("show");
                if (onConfirm) onConfirm(true); // Pass true for confirm
              });
              $cancelBtn.on("click", () => {
                $modal.removeClass("show");
                if (onConfirm) onConfirm(false); // Pass false for cancel
              });
            } else {
              $closeBtn.removeClass("hidden");
              $closeBtn.on("click", () => {
                $modal.removeClass("show");
              });
            }
          }

          $modal.addClass("show");
        },

        closeModal(modalId) {
          $(`#${modalId}`).removeClass("show");
        },

        showMessage(title, message, isConfirm = false, onConfirm = null) {
          this.showModal("messageModal", title, message, isConfirm, onConfirm);
        },

        // --- Section Management ---
        showSection(sectionId) {
          $(".section-content").removeClass("active");
          $(`#${sectionId}`).addClass("active");
          $(".nav-link")
            .removeClass("font-bold text-blue-100")
            .addClass("text-white");
          $(`.nav-link[data-section="${sectionId}"]`).addClass(
            "font-bold text-blue-100"
          );
          this.currentSection = sectionId;
          // Re-render relevant lists when section changes
          if (sectionId === "vocabulary") {
            this.renderVocabularies();
          } else if (sectionId === "grammar") {
            this.renderGrammars();
          } else if (sectionId === "settings") {
            this.renderCategories();
            this.renderStatuses();
            this.displayApiKey();
          } else if (sectionId === "review-quiz") {
            this.hideQuizAndFlashcards();
          }
        },

        // --- Category Management (for Settings) ---
        renderCategories() {
          const renderCategoryList = (listId, categories, type) => {
            const $list = $(`#${listId}`);
            $list.empty();

            let currentPageProp;
            if (type === "vocab")
              currentPageProp = this.vocabCategoryCurrentPage;
            else currentPageProp = this.grammarCategoryCurrentPage;

            const paginatedCategories = this.paginate(
              categories,
              currentPageProp,
              this.settingsItemsPerPage
            );

            if (paginatedCategories.length === 0) {
              $list.append(
                '<li class="text-center py-2 text-gray-500">No categories found.</li>'
              );
            } else {
              paginatedCategories.forEach((category) => {
                $list.append(`
                                        <li class="flex justify-between items-center py-1">
                                            <span class="text-gray-800">${category}</span>
                                            <button data-category="${category}" data-type="${type}" class="delete-category-btn text-red-500 hover:text-red-700 ml-2 transition-colors duration-200">
                                                <i class="fas fa-times-circle"></i>
                                            </button>
                                        </li>
                                    `);
              });
            }
            this.updateSettingsPaginationControls(
              `${type}Category`,
              categories.length,
              currentPageProp
            );
          };
          renderCategoryList(
            "vocabCategoryList",
            this.data.vocabCategories,
            "vocab"
          );
          renderCategoryList(
            "grammarCategoryList",
            this.data.grammarCategories,
            "grammar"
          );
        },

        addCategory(type, categoryName) {
          if (!categoryName) {
            this.showMessage(
              "Input Required",
              "Category name cannot be empty."
            );
            return;
          }
          let categories =
            type === "vocab"
              ? this.data.vocabCategories
              : this.data.grammarCategories;
          if (!categories.includes(categoryName)) {
            categories.push(categoryName);
            categories.sort(); // Keep categories sorted
            this.saveData();
            this.renderCategories();
            this.updateCategoryFilters();
            this.showMessage("Success", `Category "${categoryName}" added.`);
          } else {
            this.showMessage(
              "Info",
              `Category "${categoryName}" already exists.`
            );
          }
          // Clear input after adding
          if (type === "vocab") $("#newVocabCategoryInput").val("");
          else $("#newGrammarCategoryInput").val("");
        },

        deleteCategory(type, categoryName) {
          this.showMessage(
            "Confirm Delete",
            `Are you sure you want to delete the category "${categoryName}"? This will remove it from all associated items.`,
            true,
            (confirmed) => {
              if (!confirmed) return;
              let categories =
                type === "vocab"
                  ? this.data.vocabCategories
                  : this.data.grammarCategories;
              let items =
                type === "vocab" ? this.data.vocabularies : this.data.grammars;

              // Remove category from list
              this.data[type + "Categories"] = categories.filter(
                (cat) => cat !== categoryName
              );

              // Update items associated with this category to a default or null
              items.forEach((item) => {
                if (item.category === categoryName) {
                  item.category = "Uncategorized"; // Or another default
                }
              });
              this.saveData();
              this.renderCategories();
              this.updateCategoryFilters();
              if (type === "vocab") this.renderVocabularies();
              else this.renderGrammars();
              this.showMessage(
                "Success",
                `Category "${categoryName}" deleted.`
              );
            }
          );
        },

        // --- Status Management (for Settings) ---
        renderStatuses() {
          const $list = $(`#statusList`);
          $list.empty();

          const paginatedStatuses = this.paginate(
            this.data.learningStatuses,
            this.statusCurrentPage,
            this.settingsItemsPerPage
          );

          if (paginatedStatuses.length === 0) {
            $list.append(
              '<li class="text-center py-2 text-gray-500">No statuses found.</li>'
            );
          } else {
            paginatedStatuses.forEach((status) => {
              $list.append(`
                                    <li class="flex justify-between items-center py-1">
                                        <span class="text-gray-800">${status}</span>
                                        <button data-status="${status}" class="delete-status-btn text-red-500 hover:text-red-700 ml-2 transition-colors duration-200">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </li>
                                `);
            });
          }
          this.updateSettingsPaginationControls(
            "status",
            this.data.learningStatuses.length,
            this.statusCurrentPage
          );
        },

        addStatus(statusName) {
          if (!statusName) {
            this.showMessage("Input Required", "Status name cannot be empty.");
            return;
          }
          if (!this.data.learningStatuses.includes(statusName)) {
            this.data.learningStatuses.push(statusName);
            this.data.learningStatuses.sort();
            this.saveData();
            this.renderStatuses();
            this.showMessage("Success", `Status "${statusName}" added.`);
          } else {
            this.showMessage("Info", `Status "${statusName}" already exists.`);
          }
          $("#newStatusInput").val(""); // Clear input after adding
        },

        deleteStatus(statusName) {
          this.showMessage(
            "Confirm Delete",
            `Are you sure you want to delete the status "${statusName}"? All items currently with this status will be reset to 'New'.`,
            true,
            (confirmed) => {
              if (!confirmed) return;
              this.data.learningStatuses = this.data.learningStatuses.filter(
                (s) => s !== statusName
              );
              // Update items associated with this status to 'New' or a default
              const defaultStatus =
                this.data.learningStatuses.length > 0
                  ? this.data.learningStatuses[0]
                  : "New";
              this.data.vocabularies.forEach((item) => {
                if (item.status === statusName) item.status = defaultStatus;
              });
              this.data.grammars.forEach((item) => {
                if (item.status === statusName) item.status = defaultStatus;
              });
              this.saveData();
              this.renderStatuses();
              this.renderVocabularies(); // Re-render lists to reflect changes
              this.renderGrammars();
              this.showMessage("Success", `Status "${statusName}" deleted.`);
            }
          );
        },

        updateCategoryFilters() {
          const updateFilter = (selectId, categories) => {
            const $select = $(`#${selectId}`);
            $select.empty().append('<option value="">All Categories</option>');
            categories.forEach((category) => {
              $select.append(
                `<option value="${category}">${category}</option>`
              );
            });
          };
          updateFilter("vocabCategoryFilter", this.data.vocabCategories);
          updateFilter("grammarCategoryFilter", this.data.grammarCategories);
        },

        // New: Populate and update status filter dropdowns
        updateStatusFilters() {
          const updateFilter = (selectId, statuses) => {
            const $select = $(`#${selectId}`);
            $select.empty().append('<option value="">All Statuses</option>');
            statuses.forEach((status) => {
              $select.append(`<option value="${status}">${status}</option>`);
            });
          };
          updateFilter("vocabStatusFilter", this.data.learningStatuses);
          updateFilter("grammarStatusFilter", this.data.learningStatuses);
        },

        // --- Pagination Helper for Main Tables ---
        paginate(items, currentPage, itemsPerPage) {
          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          return items.slice(startIndex, endIndex);
        },

        // --- Pagination Helper for Settings Sections ---
        updateSettingsPaginationControls(type, totalItems, currentPage) {
          const totalPages = Math.ceil(totalItems / this.settingsItemsPerPage);
          const $prevBtn = $(`#${type}PrevPage`);
          const $nextBtn = $(`#${type}NextPage`);
          const $pageInfo = $(`#${type}PageInfo`);

          $pageInfo.text(`Page ${currentPage} of ${totalPages || 1}`);
          $prevBtn.prop("disabled", currentPage <= 1);
          $nextBtn.prop("disabled", currentPage >= totalPages);
        },

        // --- Helper to get status chip classes ---
        getStatusChipClasses(status) {
          const statusMap = {
            New: "status-new",
            Learning: "status-learning",
            Review: "status-review",
            Mastered: "status-mastered",
          };
          // Fallback to a default grey chip if status not found
          return `status-chip ${statusMap[status] || "status-default"}`;
        },

        // --- Vocabulary Section Logic ---
        renderVocabularies() {
          const searchTerm = $("#vocabSearch").val().toLowerCase();
          const categoryFilter = $("#vocabCategoryFilter").val();
          const statusFilter = $("#vocabStatusFilter").val(); // New: get status filter value

          let filteredVocab = this.data.vocabularies.filter((v) => {
            const matchesSearch =
              searchTerm === "" ||
              v.korean.toLowerCase().includes(searchTerm) ||
              v.english.toLowerCase().includes(searchTerm);
            const matchesCategory =
              categoryFilter === "" || v.category === categoryFilter;
            // New: filter by status
            const matchesStatus =
              statusFilter === "" || v.status === statusFilter;
            return matchesSearch && matchesCategory && matchesStatus; // Combine all filters
          });

          const paginatedVocab = this.paginate(
            filteredVocab,
            this.vocabCurrentPage,
            this.itemsPerPage
          );
          const $vocabList = $("#vocabList");
          $vocabList.empty();

          if (paginatedVocab.length === 0) {
            $vocabList.append(
              '<tr><td colspan="6" class="text-center py-4 text-gray-500">No vocabulary found.</td></tr>'
            );
          } else {
            paginatedVocab.forEach((vocab) => {
              const statusClasses = this.getStatusChipClasses(
                vocab.status || "New"
              );
              let resourcesHtml = "";
              // Ensure vocab.resource is an array before mapping and filter out empty strings
              const vocabResources = Array.isArray(vocab.resource)
                ? vocab.resource.filter((s) => s.trim() !== "")
                : [];

              vocabResources.forEach((res) => {
                const isUrl =
                  res.startsWith("http://") || res.startsWith("https://");
                const tagClass = isUrl ? "resource-tag-url" : "";
                const icon = isUrl
                  ? '<i class="fas fa-external-link-alt mr-1 text-sm"></i>'
                  : "";
                const onClick = isUrl
                  ? `onclick="window.open('${res}', '_blank')" style="cursor:pointer;"`
                  : "";
                resourcesHtml += `<span class="resource-tag ${tagClass}" ${onClick}><span title="${res}">${icon}${res}</span></span>`; // Add title for full text on hover
              });
              // Don't display "N/A" if resourcesHtml is empty, just leave it blank

              $vocabList.append(`
                                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                                        <td class="py-3 px-4 text-gray-700">${
                                          vocab.korean
                                        }</td>
                                        <td class="py-3 px-4 text-gray-700">${
                                          vocab.english
                                        }</td>
                                        <td class="py-3 px-4 text-gray-700">${
                                          vocab.category || "N/A"
                                        }</td>
                                        <td class="py-3 px-4 text-gray-700"><span class="${statusClasses}">${
                vocab.status || "New"
              }</span></td>
                                        <td class="py-3 px-4 text-gray-700">
                                            <div class="resource-cell-content">
                                                ${resourcesHtml}
                                            </div>
                                        </td>
                                        <td class="py-3 px-4 text-right">
                                            <div class="flex items-center space-x-2 justify-end">
                                                <button title="Ask AI" data-id="${
                                                  vocab.id
                                                }" class="ask-ai-btn text-blue-600 hover:text-blue-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-robot text-lg"></i>
                                                </button>
                                                <button title="Practice" data-id="${
                                                  vocab.id
                                                }" data-type="vocab" class="quick-practice-btn text-green-600 hover:text-green-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-keyboard text-lg"></i>
                                                </button>
                                                <button title="Edit" data-id="${
                                                  vocab.id
                                                }" class="edit-vocab-btn text-yellow-600 hover:text-yellow-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-edit text-lg"></i>
                                                </button>
                                                <button title="Delete" data-id="${
                                                  vocab.id
                                                }" class="delete-vocab-btn text-red-600 hover:text-red-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `);
            });
          }
          this.updatePaginationControls("vocab", filteredVocab.length);
        },

        updatePaginationControls(type, totalItems) {
          const currentPage =
            type === "vocab" ? this.vocabCurrentPage : this.grammarCurrentPage;
          const totalPages = Math.ceil(totalItems / this.itemsPerPage);
          const $prevBtn = $(`#${type}PrevPage`);
          const $nextBtn = $(`#${type}NextPage`);
          const $pageInfo = $(`#${type}PageInfo`);

          $pageInfo.text(`Page ${currentPage} of ${totalPages || 1}`);
          $prevBtn.prop("disabled", currentPage <= 1);
          $nextBtn.prop("disabled", currentPage >= totalPages);
        },

        openVocabModal(vocab = {}) {
          $("#dataModalTitle").text(
            vocab.id ? "Edit Vocabulary" : "Add New Vocabulary"
          );
          $("#koreanInput").val(vocab.korean || "");
          // Join array resources back to a comma-separated string for the input field
          $("#resourceInput").val(
            Array.isArray(vocab.resource)
              ? vocab.resource.join(", ")
              : vocab.resource || ""
          );
          $("#englishInput").val(vocab.english || "");

          const $categorySelect = $("#categorySelect");
          $categorySelect.empty();
          this.data.vocabCategories.forEach((cat) => {
            $categorySelect.append(`<option value="${cat}">${cat}</option>`);
          });
          if (vocab.category) {
            $categorySelect.val(vocab.category);
          } else if (this.data.vocabCategories.length === 0) {
            $categorySelect.append(
              `<option value="Uncategorized">Uncategorized</option>`
            );
            $categorySelect.val("Uncategorized");
          } else if (this.data.vocabCategories.length > 0) {
            $categorySelect.val(this.data.vocabCategories[0]);
          }

          const $statusSelect = $("#statusSelect");
          $statusSelect.empty();
          this.data.learningStatuses.forEach((status) => {
            $statusSelect.append(
              `<option value="${status}">${status}</option>`
            );
          });
          if (vocab.status) {
            $statusSelect.val(vocab.status);
          } else if (this.data.learningStatuses.length > 0) {
            $statusSelect.val(this.data.learningStatuses[0]); // Select first status by default
          } else {
            $statusSelect.append(`<option value="New">New</option>`); // Fallback if no statuses defined
            $statusSelect.val("New");
          }

          $("#dataForm").data("current-id", vocab.id || null);
          $("#dataForm").data("type", "vocab");
          this.showModal("dataModal");
        },

        saveVocab() {
          const id = $("#dataForm").data("current-id");
          const korean = $("#koreanInput").val().trim();
          const english = $("#englishInput").val().trim();
          const category = $("#categorySelect").val();
          const status = $("#statusSelect").val();
          // Split the resource input by comma and trim each part, filter out empty strings
          const resource = $("#resourceInput")
            .val()
            .split(",")
            .map((s) => s.trim())
            .filter((s) => s);

          if (!korean || !english) {
            this.showMessage(
              "Validation Error",
              "Korean and English fields cannot be empty."
            );
            return;
          }
          // Validate each URL in the resource array
          for (const res of resource) {
            if (res.startsWith("http://") || res.startsWith("https://")) {
              try {
                new URL(res); // Attempt to create a URL object to validate
              } catch (_) {
                this.showMessage(
                  "Validation Error",
                  `Invalid URL in resource: "${res}". Please ensure all URLs are valid.`
                );
                return;
              }
            }
          }

          if (id) {
            // Edit existing
            const index = this.data.vocabularies.findIndex((v) => v.id === id);
            if (index !== -1) {
              this.data.vocabularies[index] = {
                ...this.data.vocabularies[index],
                korean,
                english,
                category,
                status,
                resource,
              }; // Save resource as array
              this.showMessage("Success", "Vocabulary updated successfully!");
            }
          } else {
            // Add new
            this.data.vocabularies.push({
              id: crypto.randomUUID(),
              korean,
              english,
              category,
              status,
              resource,
            }); // Save resource as array
            this.showMessage("Success", "Vocabulary added successfully!");
          }
          this.saveData();
          this.renderVocabularies();
          this.closeModal("dataModal");
        },

        deleteVocab(id) {
          this.showMessage(
            "Confirm Delete",
            "Are you sure you want to delete this vocabulary item?",
            true,
            (confirmed) => {
              if (!confirmed) return;
              this.data.vocabularies = this.data.vocabularies.filter(
                (v) => v.id !== id
              );
              this.saveData();
              this.renderVocabularies();
              this.showMessage("Success", "Vocabulary deleted successfully!");
            }
          );
        },

        // --- Grammar Section Logic ---
        renderGrammars() {
          const searchTerm = $("#grammarSearch").val().toLowerCase();
          const categoryFilter = $("#grammarCategoryFilter").val();
          const statusFilter = $("#grammarStatusFilter").val(); // New: get status filter value

          let filteredGrammar = this.data.grammars.filter((g) => {
            const matchesSearch =
              searchTerm === "" ||
              g.korean.toLowerCase().includes(searchTerm) ||
              g.english.toLowerCase().includes(searchTerm);
            const matchesCategory =
              categoryFilter === "" || g.category === categoryFilter;
            // New: filter by status
            const matchesStatus =
              statusFilter === "" || g.status === statusFilter;
            return matchesSearch && matchesCategory && matchesStatus; // Combine all filters
          });

          const paginatedGrammar = this.paginate(
            filteredGrammar,
            this.grammarCurrentPage,
            this.itemsPerPage
          );
          const $grammarList = $("#grammarList");
          $grammarList.empty();

          if (paginatedGrammar.length === 0) {
            $grammarList.append(
              '<tr><td colspan="6" class="text-center py-4 text-gray-500">No grammar found.</td></tr>'
            );
          } else {
            paginatedGrammar.forEach((grammar) => {
              const statusClasses = this.getStatusChipClasses(
                grammar.status || "New"
              );
              let resourcesHtml = "";
              // Ensure grammar.resource is an array before mapping and filter out empty strings
              const grammarResources = Array.isArray(grammar.resource)
                ? grammar.resource.filter((s) => s.trim() !== "")
                : [];

              grammarResources.forEach((res) => {
                const isUrl =
                  res.startsWith("http://") || res.startsWith("https://");
                const tagClass = isUrl ? "resource-tag-url" : "";
                const icon = isUrl
                  ? '<i class="fas fa-external-link-alt mr-1 text-sm"></i>'
                  : "";
                const onClick = isUrl
                  ? `onclick="window.open('${res}', '_blank')" style="cursor:pointer;"`
                  : "";
                resourcesHtml += `<span class="resource-tag ${tagClass}" ${onClick}><span title="${res}">${icon}${res}</span></span>`; // Add title for full text on hover
              });
              // Don't display "N/A" if resourcesHtml is empty, just leave it blank
              $grammarList.append(`
                                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                                        <td class="py-3 px-4 text-gray-700">${
                                          grammar.korean
                                        }</td>
                                        <td class="py-3 px-4 text-gray-700">${
                                          grammar.english
                                        }</td>
                                        <td class="py-3 px-4 text-gray-700">${
                                          grammar.category || "N/A"
                                        }</td>
                                        <td class="py-3 px-4 text-gray-700"><span class="${statusClasses}">${
                grammar.status || "New"
              }</span></td>
                                        <td class="py-3 px-4 text-gray-700">
                                            <div class="resource-cell-content">
                                                ${resourcesHtml}
                                            </div>
                                        </td>
                                        <td class="py-3 px-4 text-right">
                                            <div class="flex items-center space-x-2 justify-end">
                                                <button title="Ask AI" data-id="${
                                                  grammar.id
                                                }" class="ask-ai-btn text-blue-600 hover:text-blue-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-robot text-lg"></i>
                                                </button>
                                                <button title="Practice" data-id="${
                                                  grammar.id
                                                }" data-type="grammar" class="quick-practice-btn text-green-600 hover:text-green-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-keyboard text-lg"></i>
                                                </button>
                                                <button title="Edit" data-id="${
                                                  grammar.id
                                                }" class="edit-grammar-btn text-yellow-600 hover:text-yellow-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-edit text-lg"></i>
                                                </button>
                                                <button title="Delete" data-id="${
                                                  grammar.id
                                                }" class="delete-grammar-btn text-red-600 hover:text-red-800 p-1 rounded-full transition-colors duration-200">
                                                    <i class="fas fa-trash text-lg"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `);
            });
          }
          this.updatePaginationControls("grammar", filteredGrammar.length);
        },

        openGrammarModal(grammar = {}) {
          $("#dataModalTitle").text(
            grammar.id ? "Edit Grammar" : "Add New Grammar"
          );
          $("#koreanInput").val(grammar.korean || "");
          $("#englishInput").val(grammar.english || "");
          // Join array resources back to a comma-separated string for the input field
          $("#resourceInput").val(
            Array.isArray(grammar.resource)
              ? grammar.resource.join(", ")
              : grammar.resource || ""
          );

          const $categorySelect = $("#categorySelect");
          $categorySelect.empty();
          this.data.grammarCategories.forEach((cat) => {
            $categorySelect.append(`<option value="${cat}">${cat}</option>`);
          });
          if (grammar.category) {
            $categorySelect.val(grammar.category);
          } else if (this.data.grammarCategories.length === 0) {
            $categorySelect.append(
              `<option value="Uncategorized">Uncategorized</option>`
            );
            $categorySelect.val("Uncategorized");
          } else if (this.data.grammarCategories.length > 0) {
            $categorySelect.val(this.data.grammarCategories[0]);
          }

          const $statusSelect = $("#statusSelect");
          $statusSelect.empty();
          this.data.learningStatuses.forEach((status) => {
            $statusSelect.append(
              `<option value="${status}">${status}</option>`
            );
          });
          if (grammar.status) {
            $statusSelect.val(grammar.status);
          } else if (this.data.learningStatuses.length > 0) {
            $statusSelect.val(this.data.learningStatuses[0]);
          } else {
            $statusSelect.append(`<option value="New">New</option>`);
            $statusSelect.val("New");
          }

          $("#dataForm").data("current-id", grammar.id || null);
          $("#dataForm").data("type", "grammar");
          this.showModal("dataModal");
        },

        saveGrammar() {
          const id = $("#dataForm").data("current-id");
          const korean = $("#koreanInput").val().trim();
          const english = $("#englishInput").val().trim();
          const category = $("#categorySelect").val();
          const status = $("#statusSelect").val();
          // Split the resource input by comma and trim each part, filter out empty strings
          const resource = $("#resourceInput")
            .val()
            .split(",")
            .map((s) => s.trim())
            .filter((s) => s);

          if (!korean || !english) {
            this.showMessage(
              "Validation Error",
              "Korean and English fields cannot be empty."
            );
            return;
          }
          // Validate each URL in the resource array
          for (const res of resource) {
            if (res.startsWith("http://") || res.startsWith("https://")) {
              try {
                new URL(res); // Attempt to create a URL object to validate
              } catch (_) {
                this.showMessage(
                  "Validation Error",
                  `Invalid URL in resource: "${res}". Please ensure all URLs are valid.`
                );
                return;
              }
            }
          }

          if (id) {
            // Edit existing
            const index = this.data.grammars.findIndex((g) => g.id === id);
            if (index !== -1) {
              this.data.grammars[index] = {
                ...this.data.grammars[index],
                korean,
                english,
                category,
                status,
                resource,
              }; // Save resource as array
              this.showMessage("Success", "Grammar updated successfully!");
            }
          } else {
            // Add new
            this.data.grammars.push({
              id: crypto.randomUUID(),
              korean,
              english,
              category,
              status,
              resource,
            }); // Save resource as array
            this.showMessage("Success", "Grammar added successfully!");
          }
          this.saveData();
          this.renderGrammars();
          this.closeModal("dataModal");
        },

        deleteGrammar(id) {
          this.showMessage(
            "Confirm Delete",
            "Are you sure you want to delete this grammar item?",
            true,
            (confirmed) => {
              if (!confirmed) return;
              this.data.grammars = this.data.grammars.filter(
                (g) => g.id !== id
              );
              this.saveData();
              this.renderGrammars();
              this.showMessage("Success", "Grammar deleted successfully!");
            }
          );
        },

        // --- Gemini API Integration ---
        async getGeminiExplanation(query, type) {
          if (!this.data.geminiApiKey) {
            this.showMessage(
              "API Key Missing",
              "Please set your Gemini API Key in the Settings section to use this feature."
            );
            return;
          }

          $("#aiModalContent").html(
            '<p class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i> Generating explanation...</p>'
          );
          this.showModal("aiModal");

          let prompt;
          if (type === "vocabulary") {
            prompt = `Provide a simple explanation and 3 example sentences in Korean with English translations for the Korean word "${query}". The explanation should be suitable for a beginner Korean learner.`;
          } else if (type === "grammar") {
            prompt = `Explain the Korean grammar pattern "${query}" simply. Include its usage rules, common contexts, and 3 example sentences in Korean with English translations. The explanation should be suitable for a beginner Korean learner.`;
          } else {
            prompt = `Explain "${query}" in Korean with examples.`;
          }

          try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = this.data.geminiApiKey; // Use the stored API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json();
            if (
              response.ok &&
              result.candidates &&
              result.candidates.length > 0 &&
              result.candidates[0].content &&
              result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0
            ) {
              const text = result.candidates[0].content.parts[0].text;
              $("#aiModalContent").html(text.replace(/\n/g, "<br>")); // Display newlines as breaks
            } else {
              $("#aiModalContent").html(
                '<p class="text-red-600">Failed to get explanation from AI. Please try again or check your API key.</p>'
              );
              console.error("Gemini API returned unexpected response:", result);
            }
          } catch (error) {
            $("#aiModalContent").html(
              '<p class="text-red-600">An error occurred while connecting to the AI. Please check your internet connection or API key.</p>'
            );
            console.error("Error calling Gemini API:", error);
          }
        },

        displayApiKey() {
          const apiKey = this.data.geminiApiKey;
          const $input = $("#geminiApiKeyInput");
          const $status = $("#apiKeyStatus");
          if (apiKey) {
            $input.val(apiKey);
            $status
              .text("API Key loaded (hidden for security).")
              .removeClass("text-red-600")
              .addClass("text-green-600");
          } else {
            $input.val("");
            $status
              .text("No API Key set.")
              .removeClass("text-green-600")
              .addClass("text-red-600");
          }
        },

        saveApiKey() {
          const newKey = $("#geminiApiKeyInput").val().trim();
          if (newKey) {
            this.data.geminiApiKey = newKey;
            this.saveData();
            this.showMessage("Success", "API Key saved successfully!");
            this.displayApiKey();
          } else {
            this.showMessage("Warning", "API Key cannot be empty.");
          }
        },

        async testApiKey() {
          if (!this.data.geminiApiKey) {
            this.showMessage(
              "API Key Missing",
              "Please enter an API Key first."
            );
            return;
          }
          const $status = $("#apiKeyStatus");
          $status
            .text("Testing API Key...")
            .removeClass("text-green-600 text-red-600")
            .addClass("text-gray-600");

          try {
            const testPrompt = "Say hello in Korean.";
            let chatHistory = [{ role: "user", parts: [{ text: testPrompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = this.data.geminiApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json();
            if (
              response.ok &&
              result.candidates &&
              result.candidates.length > 0
            ) {
              $status
                .text("API Key is valid!")
                .removeClass("text-red-600 text-gray-600")
                .addClass("text-green-600");
              this.showMessage(
                "API Key Test",
                "API Key is valid and successfully connected to Gemini API."
              );
            } else {
              $status
                .text("API Key Invalid or Error.")
                .removeClass("text-green-600 text-gray-600")
                .addClass("text-red-600");
              this.showMessage(
                "API Key Test Failed",
                `API Key is invalid or an error occurred. Response: ${JSON.stringify(
                  result.error || result
                )}`
              );
            }
          } catch (error) {
            $status
              .text("API Key Test Failed: Network Error.")
              .removeClass("text-green-600 text-gray-600")
              .addClass("text-red-600");
            this.showMessage(
              "API Key Test Failed",
              `Network error during API test: ${error.message}. Check console for details.`
            );
            console.error("API Test Network Error:", error);
          }
        },

        // --- Data Import/Export/Clear ---
        exportData() {
          const dataStr = JSON.stringify(this.data, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "korean_learning_data.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          this.showMessage(
            "Success",
            "Data exported successfully as korean_learning_data.json!"
          );
        },

        downloadSampleData() {
          const sampleData = {
            vocabularies: [
              {
                id: crypto.randomUUID(),
                korean: "안녕하세요",
                english: "Hello",
                category: "Basic Greetings",
                status: "New",
                resource: ["https://www.youtube.com/watch?v=hello_korean"],
              },
              {
                id: crypto.randomUUID(),
                korean: "감사합니다",
                english: "Thank you",
                category: "Basic Greetings",
                status: "Learning",
                resource: ["TTMIK Lesson 1", "My notes on politeness"],
              },
            ],
            grammars: [
              {
                id: crypto.randomUUID(),
                korean: "-(으)세요",
                english: "Please do (honorific)",
                category: "Basic Endings",
                status: "New",
                resource: [
                  "https://koreanly.com/grammar/euseyo",
                  "Workbook pg 12",
                ],
              },
              {
                id: crypto.randomUUID(),
                korean: "-고 싶다",
                english: "To want to",
                category: "Desire Expressions",
                status: "Learning",
                resource: ["Grammar explanation video"],
              },
            ],
            vocabCategories: [
              "Basic Greetings",
              "Food",
              "Places",
              "Actions",
              "Emotions",
              "Numbers",
            ],
            grammarCategories: [
              "Basic Endings",
              "Conjunctions",
              "Honorifics",
              "Tenses",
              "Desire Expressions",
            ],
            learningStatuses: ["New", "Learning", "Review", "Mastered"],
            geminiApiKey: "", // Sample data does not include an API key
          };
          const dataStr = JSON.stringify(sampleData, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "korean_learning_sample.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          this.showMessage(
            "Success",
            "Sample data downloaded as korean_learning_sample.json!"
          );
        },

        importData(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedData = JSON.parse(e.target.result);

              // Prompt user to append or replace
              this.showModal(
                "messageModal",
                "Import Data",
                "Do you want to append this data to your existing data or replace all your current data?",
                true,
                (confirmed) => {
                  if (confirmed === true) {
                    // User chose 'Append' (first button)
                    // Append logic
                    importedData.vocabularies.forEach((newItem) => {
                      // Check if item with same ID exists, if so, update; otherwise, add new
                      const existingIndex = this.data.vocabularies.findIndex(
                        (item) => item.id === newItem.id
                      );
                      if (existingIndex !== -1) {
                        this.data.vocabularies[existingIndex] = newItem; // Overwrite existing
                      } else {
                        this.data.vocabularies.push(newItem); // Add new
                      }
                    });
                    importedData.grammars.forEach((newItem) => {
                      const existingIndex = this.data.grammars.findIndex(
                        (item) => item.id === newItem.id
                      );
                      if (existingIndex !== -1) {
                        this.data.grammars[existingIndex] = newItem;
                      } else {
                        this.data.grammars.push(newItem);
                      }
                    });

                    // Merge categories and statuses (only add new unique ones)
                    this.data.vocabCategories = [
                      ...new Set([
                        ...this.data.vocabCategories,
                        ...(importedData.vocabCategories || []),
                      ]),
                    ].sort();
                    this.data.grammarCategories = [
                      ...new Set([
                        ...this.data.grammarCategories,
                        ...(importedData.grammarCategories || []),
                      ]),
                    ].sort();
                    this.data.learningStatuses = [
                      ...new Set([
                        ...this.data.learningStatuses,
                        ...(importedData.learningStatuses || []),
                      ]),
                    ].sort();

                    this.saveData();
                    this.loadData(); // Reload to refresh UI and ensure resource array conversion
                    this.renderVocabularies();
                    this.renderGrammars();
                    this.renderCategories();
                    this.renderStatuses();
                    this.displayApiKey();
                    this.showMessage("Success", "Data appended successfully!");
                  } else if (confirmed === false) {
                    // User chose 'Cancel' (second button, for replace)
                    // Replace logic
                    if (
                      importedData.vocabularies &&
                      importedData.grammars &&
                      importedData.vocabCategories &&
                      importedData.grammarCategories
                    ) {
                      this.data = {
                        vocabularies: importedData.vocabularies || [],
                        grammars: importedData.grammars || [],
                        vocabCategories: importedData.vocabCategories || [
                          "Basic Greetings",
                          "Food",
                          "Places",
                          "Actions",
                        ],
                        grammarCategories: importedData.grammarCategories || [
                          "Basic Endings",
                          "Conjunctions",
                          "Honorifics",
                          "Tenses",
                        ],
                        learningStatuses: importedData.learningStatuses || [
                          "New",
                          "Learning",
                          "Review",
                          "Mastered",
                        ],
                        geminiApiKey: importedData.geminiApiKey || "",
                      };
                      this.saveData();
                      this.loadData(); // Reload to refresh UI (handles resource format conversion now)
                      this.renderVocabularies();
                      this.renderGrammars();
                      this.renderCategories();
                      this.renderStatuses();
                      this.displayApiKey();
                      this.showMessage(
                        "Success",
                        "Data replaced successfully!"
                      );
                    } else {
                      this.showMessage(
                        "Import Error",
                        "Invalid data format. Please select a valid .json file from this app."
                      );
                    }
                  }
                  // Clear the file input after processing
                  $("#importFileInput").val("");
                }
              );

              // Dynamically change message modal buttons for import choice
              $("#confirmMessageModalBtn").text("Append Data");
              $("#cancelMessageModalBtn").text("Replace All Data"); // This button acts as 'replace'
              $("#closeMessageModalBtn").addClass("hidden"); // Hide default OK
            } catch (error) {
              this.showMessage(
                "Import Error",
                "Failed to parse JSON file. Please ensure it's a valid JSON format."
              );
              console.error("Error importing data:", error);
              $("#importFileInput").val(""); // Clear the file input
            }
          };
          reader.readAsText(file);
        },

        clearAllData() {
          this.showMessage(
            "Confirm Clear",
            "Are you sure you want to clear ALL data? This action cannot be undone.",
            true,
            (confirmed) => {
              if (!confirmed) return;
              this.data = {
                // Reset to initial empty state with default categories and statuses
                vocabularies: [],
                grammars: [],
                vocabCategories: [
                  "Basic Greetings",
                  "Food",
                  "Places",
                  "Actions",
                ],
                grammarCategories: [
                  "Basic Endings",
                  "Conjunctions",
                  "Honorifics",
                  "Tenses",
                ],
                learningStatuses: ["New", "Learning", "Review", "Mastered"],
                geminiApiKey: "",
              };
              this.saveData();
              this.loadData(); // Reload to refresh UI
              this.renderVocabularies();
              this.renderGrammars();
              this.renderCategories();
              this.renderStatuses(); // Re-render statuses
              this.showMessage("Success", "All data cleared successfully!");
            }
          );
        },

        // --- Review & Quiz Logic ---
        hideQuizAndFlashcards() {
          $("#flashcardContainer").addClass("hidden");
          $("#quizContainer").addClass("hidden");
          $("#startFlashcardsBtn").removeClass("hidden");
          $("#startQuizBtn").removeClass("hidden");
        },

        startFlashcards() {
          if (
            this.data.vocabularies.length === 0 &&
            this.data.grammars.length === 0
          ) {
            this.showMessage(
              "No Data",
              "Please add some Vocabulary or Grammar items first to start flashcards."
            );
            return;
          }
          this.hideQuizAndFlashcards();
          $("#flashcardContainer").removeClass("hidden");
          this.quiz.allWords = [
            ...this.data.vocabularies,
            ...this.data.grammars,
          ].sort(() => 0.5 - Math.random()); // Shuffle
          this.quiz.currentQuestionIndex = 0;
          this.showNextFlashcard();
        },

        showNextFlashcard() {
          if (this.quiz.currentQuestionIndex >= this.quiz.allWords.length) {
            this.showMessage(
              "Flashcards Done!",
              "You've gone through all the flashcards. Restarting from the beginning!"
            );
            this.quiz.currentQuestionIndex = 0; // Loop back to start
            this.quiz.allWords.sort(() => 0.5 - Math.random()); // Reshuffle
          }

          const currentItem =
            this.quiz.allWords[this.quiz.currentQuestionIndex];
          const $flashcard = $("#flashcard");
          const $content = $("#flashcardContent");
          const $side = $("#flashcardSide");

          $content.text(currentItem.korean);
          $flashcard.data("korean", currentItem.korean);
          $flashcard.data("english", currentItem.english);
          $flashcard.data("flipped", false);
          $side.text("Korean");
          $flashcard
            .removeClass("bg-blue-500 text-white")
            .addClass("bg-white text-gray-800 border-blue-400"); // Reset styling
        },

        flipFlashcard() {
          const $flashcard = $("#flashcard");
          const $content = $("#flashcardContent");
          const $side = $("#flashcardSide");
          const isFlipped = $flashcard.data("flipped");

          if (!isFlipped) {
            $content.text($flashcard.data("english"));
            $side.text("English");
            $flashcard.data("flipped", true);
            $flashcard
              .removeClass("bg-white text-gray-800 border-blue-400")
              .addClass("bg-blue-500 text-white"); // Add flipped styling
          } else {
            $content.text($flashcard.data("korean"));
            $side.text("Korean");
            $flashcard.data("flipped", false);
            $flashcard
              .removeClass("bg-blue-500 text-white")
              .addClass("bg-white text-gray-800 border-blue-400"); // Remove flipped styling
          }
        },

        startQuiz() {
          this.quiz.allWords = [
            ...this.data.vocabularies,
            ...this.data.grammars,
          ];
          if (this.quiz.allWords.length < 4) {
            this.showMessage(
              "Not Enough Data",
              "You need at least 4 vocabulary/grammar items to start a quiz."
            );
            return;
          }

          this.hideQuizAndFlashcards();
          $("#quizContainer").removeClass("hidden");
          this.quiz.score = 0;
          this.quiz.currentQuestionIndex = 0;
          this.generateQuizQuestions();
          this.showNextQuizQuestion();
        },

        generateQuizQuestions() {
          const allItems = [...this.data.vocabularies, ...this.data.grammars];
          this.quiz.questions = [];

          if (allItems.length < 4) {
            return; // Not enough items to create questions
          }

          // Shuffle items to get random questions
          const shuffledItems = allItems.sort(() => 0.5 - Math.random());

          // Generate questions (e.g., 10 questions or all if less than 10)
          const numQuestions = Math.min(shuffledItems.length, 10);

          for (let i = 0; i < numQuestions; i++) {
            const correctItem = shuffledItems[i];
            let options = [correctItem.english];

            // Generate 3 incorrect options
            while (options.length < 4) {
              const randomItem =
                allItems[Math.floor(Math.random() * allItems.length)];
              if (
                randomItem.english !== correctItem.english &&
                !options.includes(randomItem.english)
              ) {
                options.push(randomItem.english);
              }
            }
            options.sort(() => 0.5 - Math.random()); // Shuffle options

            this.quiz.questions.push({
              korean: correctItem.korean,
              correctAnswer: correctItem.english,
              options: options,
            });
          }
          $("#quizTotalQuestions").text(this.quiz.questions.length);
        },

        showNextQuizQuestion() {
          if (this.quiz.currentQuestionIndex >= this.quiz.questions.length) {
            this.endQuiz();
            return;
          }

          const question = this.quiz.questions[this.quiz.currentQuestionIndex];
          $("#quizQuestion").text(
            `What is the English meaning of "${question.korean}"?`
          );
          $("#quizScore").text(this.quiz.score);
          $("#quizCurrentQuestion").text(this.quiz.currentQuestionIndex + 1);

          const $optionsContainer = $("#quizOptions");
          $optionsContainer.empty();
          question.options.forEach((option) => {
            $optionsContainer.append(`
                                <button class="quiz-option-button bg-gray-200 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-300 transition duration-300 w-full text-left font-medium shadow-sm" data-answer="${option}">
                                    ${option}
                                </button>
                            `);
          });

          $(".quiz-option-button")
            .removeClass("correct incorrect")
            .prop("disabled", false); // Reset button states
          $("#nextQuizQuestionBtn").addClass("hidden");
          $("#restartQuizBtn").addClass("hidden");
        },

        checkQuizAnswer(selectedAnswer) {
          const question = this.quiz.questions[this.quiz.currentQuestionIndex];
          const $options = $(".quiz-option-button");
          $options.prop("disabled", true); // Disable all options after selection

          if (selectedAnswer === question.correctAnswer) {
            this.quiz.score++;
            $(`button[data-answer="${selectedAnswer}"]`).addClass("correct");
          } else {
            $(`button[data-answer="${selectedAnswer}"]`).addClass("incorrect");
            $(`button[data-answer="${question.correctAnswer}"]`).addClass(
              "correct"
            ); // Highlight correct answer
          }
          $("#quizScore").text(this.quiz.score);
          $("#nextQuizQuestionBtn").removeClass("hidden"); // Show next question button
        },

        endQuiz() {
          $("#quizQuestion").text("Quiz Completed!");
          $("#quizOptions")
            .empty()
            .append(
              `<p class="text-xl font-bold text-center">Your final score: ${this.quiz.score} out of ${this.quiz.questions.length}</p>`
            );
          $("#nextQuizQuestionBtn").addClass("hidden");
          $("#restartQuizBtn").removeClass("hidden");
        },

        // --- Quick Practice Logic ---
        openPracticeModal(item, type) {
          $("#practiceModal").data("correct-answer", item.english);
          $("#practiceModal").data("item-korean", item.korean);
          $("#practiceKorean").text(item.korean);
          $("#practiceAnswerInput")
            .val("")
            .removeClass("border-red-500 border-green-500")
            .prop("disabled", false)
            .focus(); // Clear and enable input, set focus
          $("#practiceFeedback")
            .text("")
            .removeClass("text-red-600 text-green-600");
          $("#checkPracticeAnswerBtn").removeClass("hidden");
          this.showModal("practiceModal");
        },

        checkPracticeAnswer() {
          const userAnswer = $("#practiceAnswerInput").val().trim();
          const correctAnswer = $("#practiceModal").data("correct-answer");
          const $feedback = $("#practiceFeedback");
          const $input = $("#practiceAnswerInput");

          if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
            $feedback.text("Correct! 🎉").addClass("text-green-600");
            $input.removeClass("border-red-500").addClass("border-green-500");
            $("#checkPracticeAnswerBtn").addClass("hidden");
          } else {
            $feedback
              .html(
                `Incorrect. The correct answer is: <span class="font-bold">${correctAnswer}</span>`
              )
              .addClass("text-red-600");
            $input.removeClass("border-green-500").addClass("border-red-500");
          }
          $input.prop("disabled", true);
        },

        // --- Guide Modal Logic ---
        showGuideModal() {
          this.showModal("guideModal");
          // Ensure initial tab is active
          $("#guideModal .tab-button")
            .removeClass("active-tab-button border-blue-600")
            .addClass("border-transparent");
          $("#guideModal .tab-content")
            .addClass("hidden")
            .removeClass("active-tab-content");
          $('#guideModal .tab-button[data-tab="about"]').addClass(
            "active-tab-button border-blue-600"
          );
          $("#aboutTab").addClass("active-tab-content").removeClass("hidden");
        },
        switchGuideTab(tabName) {
          $("#guideModal .tab-button")
            .removeClass("active-tab-button border-blue-600")
            .addClass("border-transparent");
          $("#guideModal .tab-content")
            .addClass("hidden")
            .removeClass("active-tab-content");

          $(`#guideModal .tab-button[data-tab="${tabName}"]`).addClass(
            "active-tab-button border-blue-600"
          );
          $(`#${tabName}Tab`)
            .addClass("active-tab-content")
            .removeClass("hidden");
        },

        // --- Event Listeners ---
        addEventListeners() {
          // Navigation
          $(".nav-link").on("click", function (e) {
            e.preventDefault();
            app.showSection($(this).data("section"));
          });

          // Vocabulary
          $("#vocabSearch").on(
            "keyup",
            $.debounce(300, () => app.renderVocabularies())
          );
          $("#vocabCategoryFilter").on("change", () =>
            app.renderVocabularies()
          );
          $("#vocabStatusFilter").on("change", () => app.renderVocabularies()); // New: Status filter event
          $("#addVocabBtn").on("click", () => app.openVocabModal());
          $(document).on("click", ".edit-vocab-btn", function () {
            const id = $(this).data("id");
            const vocab = app.data.vocabularies.find((v) => v.id === id);
            if (vocab) app.openVocabModal(vocab);
          });
          $(document).on("click", ".delete-vocab-btn", function () {
            app.deleteVocab($(this).data("id"));
          });
          $("#vocabPrevPage").on("click", () => {
            if (app.vocabCurrentPage > 1) {
              app.vocabCurrentPage--;
              app.renderVocabularies();
            }
          });
          $("#vocabNextPage").on("click", () => {
            const searchTerm = $("#vocabSearch").val().toLowerCase();
            const categoryFilter = $("#vocabCategoryFilter").val();
            const statusFilter = $("#vocabStatusFilter").val();
            const totalItems = app.data.vocabularies.filter((v) => {
              const matchesSearch =
                searchTerm === "" ||
                v.korean.toLowerCase().includes(searchTerm) ||
                v.english.toLowerCase().includes(searchTerm);
              const matchesCategory =
                categoryFilter === "" || v.category === categoryFilter;
              const matchesStatus =
                statusFilter === "" || v.status === statusFilter;
              return matchesSearch && matchesCategory && matchesStatus;
            }).length;
            const totalPages = Math.ceil(totalItems / app.itemsPerPage);
            if (app.vocabCurrentPage < totalPages) {
              app.vocabCurrentPage++;
              app.renderVocabularies();
            }
          });

          // Grammar
          $("#grammarSearch").on(
            "keyup",
            $.debounce(300, () => app.renderGrammars())
          );
          $("#grammarCategoryFilter").on("change", () => app.renderGrammars());
          $("#grammarStatusFilter").on("change", () => app.renderGrammars()); // New: Status filter event
          $("#addGrammarBtn").on("click", () => app.openGrammarModal());
          $(document).on("click", ".edit-grammar-btn", function () {
            const id = $(this).data("id");
            const grammar = app.data.grammars.find((g) => g.id === id);
            if (grammar) app.openGrammarModal(grammar);
          });
          $(document).on("click", ".delete-grammar-btn", function () {
            app.deleteGrammar($(this).data("id"));
          });
          $("#grammarPrevPage").on("click", () => {
            if (app.grammarCurrentPage > 1) {
              app.grammarCurrentPage--;
              app.renderGrammars();
            }
          });
          $("#grammarNextPage").on("click", () => {
            const searchTerm = $("#grammarSearch").val().toLowerCase();
            const categoryFilter = $("#grammarCategoryFilter").val();
            const statusFilter = $("#grammarStatusFilter").val();
            const totalItems = app.data.grammars.filter((g) => {
              const matchesSearch =
                searchTerm === "" ||
                g.korean.toLowerCase().includes(searchTerm) ||
                g.english.toLowerCase().includes(searchTerm);
              const matchesCategory =
                categoryFilter === "" || g.category === categoryFilter;
              const matchesStatus =
                statusFilter === "" || g.status === statusFilter;
              return matchesSearch && matchesCategory && matchesStatus;
            }).length;
            const totalPages = Math.ceil(totalItems / app.itemsPerPage);
            if (app.grammarCurrentPage < totalPages) {
              app.grammarCurrentPage++;
              app.renderGrammars();
            }
          });

          // Data Modal Save/Cancel
          $("#dataForm").on("submit", function (e) {
            e.preventDefault();
            const type = $(this).data("type");
            if (type === "vocab") app.saveVocab();
            else if (type === "grammar") app.saveGrammar();
          });
          $("#cancelDataModalBtn").on("click", () =>
            app.closeModal("dataModal")
          );

          // AI Explanation
          $(document).on("click", ".ask-ai-btn", function () {
            const id = $(this).data("id");
            let item;
            let type;
            item = app.data.vocabularies.find((v) => v.id === id);
            if (item) {
              type = "vocabulary";
            } else {
              item = app.data.grammars.find((g) => g.id === id);
              if (item) {
                type = "grammar";
              }
            }

            if (item) {
              app.getGeminiExplanation(item.korean, type);
            } else {
              app.showMessage("Error", "Item not found for AI explanation.");
            }
          });
          $("#closeAiModalBtn").on("click", () => app.closeModal("aiModal"));

          // Settings - Categories
          $("#addVocabCategoryBtn").on("click", () =>
            app.addCategory("vocab", $("#newVocabCategoryInput").val().trim())
          );
          $("#addGrammarCategoryBtn").on("click", () =>
            app.addCategory(
              "grammar",
              $("#newGrammarCategoryInput").val().trim()
            )
          );
          $(document).on("click", ".delete-category-btn", function () {
            app.deleteCategory($(this).data("type"), $(this).data("category"));
          });
          $("#vocabCategoryPrevPage").on("click", () => {
            if (app.vocabCategoryCurrentPage > 1) {
              app.vocabCategoryCurrentPage--;
              app.renderCategories();
            }
          });
          $("#vocabCategoryNextPage").on("click", () => {
            const totalPages = Math.ceil(
              app.data.vocabCategories.length / app.settingsItemsPerPage
            );
            if (app.vocabCategoryCurrentPage < totalPages) {
              app.vocabCategoryCurrentPage++;
              app.renderCategories();
            }
          });
          $("#grammarCategoryPrevPage").on("click", () => {
            if (app.grammarCategoryCurrentPage > 1) {
              app.grammarCategoryCurrentPage--;
              app.renderCategories();
            }
          });
          $("#grammarCategoryNextPage").on("click", () => {
            const totalPages = Math.ceil(
              app.data.grammarCategories.length / app.settingsItemsPerPage
            );
            if (app.grammarCategoryCurrentPage < totalPages) {
              app.grammarCategoryCurrentPage++;
              app.renderCategories();
            }
          });

          // Settings - Statuses
          $("#addStatusBtn").on("click", () =>
            app.addStatus($("#newStatusInput").val().trim())
          );
          $(document).on("click", ".delete-status-btn", function () {
            app.deleteStatus($(this).data("status"));
          });
          $("#statusPrevPage").on("click", () => {
            if (app.statusCurrentPage > 1) {
              app.statusCurrentPage--;
              app.renderStatuses();
            }
          });
          $("#statusNextPage").on("click", () => {
            const totalPages = Math.ceil(
              app.data.learningStatuses.length / app.settingsItemsPerPage
            );
            if (app.statusCurrentPage < totalPages) {
              app.statusCurrentPage++;
              app.renderStatuses();
            }
          });

          // Settings - Data Management
          $("#exportDataBtn").on("click", () => app.exportData());
          $("#downloadSampleDataBtn").on("click", () =>
            app.downloadSampleData()
          ); // New sample download button
          $("#importFileInput").on("change", (e) => app.importData(e));
          $("#clearDataBtn").on("click", () => app.clearAllData());

          // Settings - API Key
          $("#saveApiKeyBtn").on("click", () => app.saveApiKey());
          $("#testApiKeyBtn").on("click", () => app.testApiKey());

          // Review & Quiz
          $("#startFlashcardsBtn").on("click", () => app.startFlashcards());
          $("#flashcard").on("click", () => app.flipFlashcard());
          $("#nextFlashcardBtn").on("click", () => {
            app.quiz.currentQuestionIndex++;
            app.showNextFlashcard();
          });
          $("#startQuizBtn").on("click", () => app.startQuiz());
          $(document).on("click", ".quiz-option-button", function () {
            app.checkQuizAnswer($(this).data("answer"));
          });
          $("#nextQuizQuestionBtn").on("click", () => {
            app.quiz.currentQuestionIndex++;
            app.showNextQuizQuestion();
          });
          $("#restartQuizBtn").on("click", () => app.startQuiz());

          // Quick Practice
          $(document).on("click", ".quick-practice-btn", function () {
            const id = $(this).data("id");
            const type = $(this).data("type");
            let item;
            if (type === "vocab") {
              item = app.data.vocabularies.find((v) => v.id === id);
            } else if (type === "grammar") {
              item = app.data.grammars.find((g) => g.id === id);
            }

            if (item) {
              app.openPracticeModal(item, type);
            } else {
              app.showMessage("Error", "Practice item not found.");
            }
          });
          $("#checkPracticeAnswerBtn").on("click", () =>
            app.checkPracticeAnswer()
          );
          $("#practiceAnswerInput").on("keypress", function (e) {
            if (e.which === 13) {
              // Enter key
              e.preventDefault();
              if (!$(this).prop("disabled")) {
                // Only check if not disabled
                app.checkPracticeAnswer();
              }
            }
          });
          $("#closePracticeModalBtn").on("click", () =>
            app.closeModal("practiceModal")
          );

          // Guide Button and Modal
          $("#guideFab").on("click", () => app.showGuideModal());
          $("#closeGuideModalBtn").on("click", () =>
            app.closeModal("guideModal")
          );
          $("#guideModal .tab-button").on("click", function () {
            app.switchGuideTab($(this).data("tab"));
          });
        },

        // --- Initialization ---
        init() {
          this.loadData();
          this.addEventListeners();
          this.showSection(this.currentSection); // Show initial section (vocabulary)
          // Add some initial dummy data if storage is empty for demonstration
          if (this.data.vocabularies.length === 0) {
            this.data.vocabularies.push(
              {
                id: crypto.randomUUID(),
                korean: "안녕하세요",
                english: "Hello",
                category: "Basic Greetings",
                status: "New",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "감사합니다",
                english: "Thank you",
                category: "Basic Greetings",
                status: "Learning",
                resource: [
                  "https://www.youtube.com/watch?v=tutorial_thank_you",
                  "TTMIK Lesson",
                ],
              },
              {
                id: crypto.randomUUID(),
                korean: "미안합니다",
                english: "I am sorry",
                category: "Basic Greetings",
                status: "Review",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "네",
                english: "Yes",
                category: "Basic Greetings",
                status: "Mastered",
                resource: ["More notes on 'Ne'", "https://www.duolingo.com"],
              },
              {
                id: crypto.randomUUID(),
                korean: "아니요",
                english: "No",
                category: "Basic Greetings",
                status: "New",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "사랑",
                english: "Love",
                category: "Emotions",
                status: "Learning",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "행복",
                english: "Happiness",
                category: "Emotions",
                status: "Review",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "물",
                english: "Water",
                category: "Food",
                status: "Mastered",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "밥",
                english: "Rice / Meal",
                category: "Food",
                status: "New",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "학교",
                english: "School",
                category: "Places",
                status: "Learning",
                resource: [],
              }
            );
          }
          if (this.data.grammars.length === 0) {
            this.data.grammars.push(
              {
                id: crypto.randomUUID(),
                korean: "-(으)세요",
                english: "Please do (honorific)",
                category: "Basic Endings",
                status: "New",
                resource: ["https://koreanly.com/grammar/euseyo"],
              },
              {
                id: crypto.randomUUID(),
                korean: "-고 싶다",
                english: "To want to",
                category: "Desire Expressions",
                status: "Learning",
                resource: ["Lesson 5", "https://example.com/want-to"],
              },
              {
                id: crypto.randomUUID(),
                korean: "-습니다 / -ㅂ니다",
                english: "Formal ending (declarative)",
                category: "Basic Endings",
                status: "Review",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "-아/어/여요",
                english: "Informal polite ending",
                category: "Basic Endings",
                status: "Mastered",
                resource: ["More details on informal polite"],
              },
              {
                id: crypto.randomUUID(),
                korean: "그리고",
                english: "And (connective)",
                category: "Conjunctions",
                status: "New",
                resource: [],
              },
              {
                id: crypto.randomUUID(),
                korean: "하지만",
                english: "But (connective)",
                category: "Conjunctions",
                status: "Learning",
                resource: [],
              }
            );
          }
          this.saveData(); // Save dummy data if it was just added
          this.renderVocabularies(); // Initial render for vocabulary
          this.renderGrammars(); // Initial render for grammar
          this.renderCategories(); // Initial render for categories
          this.renderStatuses(); // Initial render for statuses
        },
      };

      // jQuery debounce function for search inputs
      $.debounce = function (delay, fn) {
        let timeout;
        return function () {
          const context = this,
            args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(function () {
            fn.apply(context, args);
          }, delay);
        };
      };

      // Initialize the app when the document is ready
      $(document).ready(() => {
        app.init();
      });
    </script>
  </body>
</html>
